name: CD - Deploy to EC2 with Docker Compose

on:
  workflow_run:
    workflows: [ "CI - Build and Push Docker Image" ]
    types: [ completed ]
    branches: [ main ]

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: self-hosted

    steps:
      - name: 아티팩트 다운로드 (이미지 태그 가져오기)
        uses: actions/download-artifact@v3
        with:
          name: build-artifact
          run-id: ${{ github.event.workflow_run.id }}

      - name: 이미지 태그를 환경 변수로 설정
        run: echo "IMAGE_TAG=$(cat image-tag.txt)" >> $GITHUB_ENV

      - name: Docker Hub 로그인
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 최신 이미지 pull
        run: docker pull ${{ secrets.DOCKER_USERNAME }}/terning-farewell-server:${{ env.IMAGE_TAG }}

      - name: 블루/그린 배포 스크립트 실행
        env:
          DB_PROD_URL: ${{ vars.DB_PROD_URL }}
          DB_PROD_USERNAME: ${{ secrets.DB_PROD_USERNAME }}
          DB_PROD_PASSWORD: ${{ secrets.DB_PROD_PASSWORD }}
        run: |
          BLUE=$(docker ps --filter "name=blue" --format "{{.Names}}")
          if [ -z "$BLUE" ]; then
            OLD_CONTAINER_NAME=green
            NEW_CONTAINER_NAME=blue
            NEW_PORT=8080
          else
            OLD_CONTAINER_NAME=blue
            NEW_CONTAINER_NAME=green
            NEW_PORT=8081
          fi

          echo "Deploying new container: ${NEW_CONTAINER_NAME} on port ${NEW_PORT}"
          
          cd /app
          docker compose -p ${NEW_CONTAINER_NAME} --env-file ./.env up -d --no-deps

          echo "Waiting for new container to start..."
          sleep 15

          HEALTH_CHECK_URL="http://localhost:${NEW_PORT}/actuator/health"
          for i in {1..10}; do
            RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_CHECK_URL)
            if [ "$RESPONSE_CODE" = "200" ]; then
              echo "Health check successful!"
              break
            fi
            echo "Health check failed (Attempt $i/10). Retrying in 5 seconds..."
            sleep 5
            if [ $i -eq 10 ]; then
              echo "Deployment failed after multiple health checks."
              docker compose -p ${NEW_CONTAINER_NAME} down
              exit 1
            fi
          done

          echo "set \$service_url http://127.0.0.1:${NEW_PORT};" | sudo tee /etc/nginx/conf.d/service-url.inc
          sudo systemctl reload nginx
          echo "Nginx reloaded to point to port ${NEW_PORT}"

          EXISTING_OLD=$(docker ps -a --filter "name=${OLD_CONTAINER_NAME}" --format "{{.Names}}")
          if [ ! -z "$EXISTING_OLD" ]; then
            docker compose -p ${OLD_CONTAINER_NAME} down
            echo "Stopped and removed old container: ${OLD_CONTAINER_NAME}"
          fi
          
      - name: 오래된 Docker 이미지 정리
        run: docker image prune -f
